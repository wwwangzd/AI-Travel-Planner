# AI 旅行规划师设计文档

## 系统架构设计

### 整体架构
```
前端 (React/Vue) 
    ↓
API 网关层
    ↓
业务服务层 (Node.js/Python)
    ↓
数据存储层 (Supabase/Firebase) + 外部服务 (LLM API, 地图 API, 语音 API)
```

### 技术栈选型

**前端**
- 框架：React + TypeScript
- 状态管理：Zustand / Redux Toolkit
- UI 组件库：Ant Design / Material-UI
- 地图组件：高德地图 Web SDK
- 语音录制：RecordRTC / MediaRecorder API

**后端**
- 运行时：Node.js
- 框架：Express / Fastify
- 语言：TypeScript

**数据库与认证**
- Supabase (PostgreSQL + Auth + Storage)

**外部服务**
- LLM：OpenAI API / 阿里云通义千问 / 其他
- 语音识别：科大讯飞语音听写 API
- 地图服务：高德地图 Web API

**部署**
- 容器化：Docker + Docker Compose
- 前端：Nginx
- 后端：Node.js

## 数据库设计

### 用户表 (users)
```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  email VARCHAR(255) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  username VARCHAR(100),
  avatar_url TEXT,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

### 旅行计划表 (travel_plans)
```sql
CREATE TABLE travel_plans (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  title VARCHAR(255) NOT NULL,
  destination VARCHAR(255) NOT NULL,
  start_date DATE NOT NULL,
  end_date DATE NOT NULL,
  budget DECIMAL(10, 2),
  travelers_count INTEGER,
  preferences JSONB,
  status VARCHAR(50) DEFAULT 'draft',
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

### 行程详情表 (itinerary_items)
```sql
CREATE TABLE itinerary_items (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  plan_id UUID REFERENCES travel_plans(id) ON DELETE CASCADE,
  day_number INTEGER NOT NULL,
  item_type VARCHAR(50) NOT NULL,
  title VARCHAR(255) NOT NULL,
  description TEXT,
  location JSONB,
  start_time TIME,
  end_time TIME,
  estimated_cost DECIMAL(10, 2),
  booking_info JSONB,
  sort_order INTEGER,
  created_at TIMESTAMP DEFAULT NOW()
);
```

### 费用记录表 (expenses)
```sql
CREATE TABLE expenses (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  plan_id UUID REFERENCES travel_plans(id) ON DELETE CASCADE,
  category VARCHAR(100) NOT NULL,
  amount DECIMAL(10, 2) NOT NULL,
  currency VARCHAR(10) DEFAULT 'CNY',
  description TEXT,
  expense_date DATE NOT NULL,
  created_by VARCHAR(50),
  created_at TIMESTAMP DEFAULT NOW()
);
```

### 用户偏好表 (user_preferences)
```sql
CREATE TABLE user_preferences (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  preference_key VARCHAR(100) NOT NULL,
  preference_value JSONB,
  updated_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(user_id, preference_key)
);
```

## API 接口设计

### 认证模块

#### POST /api/auth/register
注册新用户
```json
Request:
{
  "email": "user@example.com",
  "password": "password123",
  "username": "username"
}

Response:
{
  "success": true,
  "data": {
    "user": { "id": "uuid", "email": "user@example.com" },
    "token": "jwt_token"
  }
}
```

#### POST /api/auth/login
用户登录
```json
Request:
{
  "email": "user@example.com",
  "password": "password123"
}

Response:
{
  "success": true,
  "data": {
    "user": { "id": "uuid", "email": "user@example.com" },
    "token": "jwt_token"
  }
}
```

#### POST /api/auth/logout
用户登出

### 语音模块

#### POST /api/voice/recognize
语音识别
```json
Request:
Content-Type: multipart/form-data
{
  "audio": File (WAV/MP3)
}

Response:
{
  "success": true,
  "data": {
    "text": "我想去日本，5天，预算1万元",
    "confidence": 0.95
  }
}
```

### 行程规划模块

#### POST /api/plans/generate
生成旅行计划
```json
Request:
{
  "destination": "日本",
  "startDate": "2025-12-01",
  "endDate": "2025-12-05",
  "budget": 10000,
  "travelersCount": 2,
  "preferences": {
    "interests": ["美食", "动漫"],
    "withKids": true,
    "accommodation": "舒适型"
  }
}

Response:
{
  "success": true,
  "data": {
    "planId": "uuid",
    "title": "日本5日游",
    "itinerary": [
      {
        "day": 1,
        "items": [
          {
            "type": "transportation",
            "title": "上海->东京",
            "time": "08:00-12:00",
            "cost": 2000,
            "details": {}
          },
          {
            "type": "accommodation",
            "title": "东京XX酒店",
            "cost": 800,
            "location": { "lat": 35.6762, "lng": 139.6503 }
          }
        ]
      }
    ],
    "budgetBreakdown": {
      "transportation": 4000,
      "accommodation": 3000,
      "food": 2000,
      "activities": 1000
    }
  }
}
```

#### GET /api/plans
获取用户的所有旅行计划
```json
Response:
{
  "success": true,
  "data": {
    "plans": [
      {
        "id": "uuid",
        "title": "日本5日游",
        "destination": "日本",
        "startDate": "2025-12-01",
        "endDate": "2025-12-05",
        "status": "draft"
      }
    ]
  }
}
```

#### GET /api/plans/:id
获取指定旅行计划详情

#### PUT /api/plans/:id
更新旅行计划

#### DELETE /api/plans/:id
删除旅行计划

### 费用管理模块

#### POST /api/expenses
添加费用记录
```json
Request:
{
  "planId": "uuid",
  "category": "餐饮",
  "amount": 150.50,
  "description": "午餐",
  "expenseDate": "2025-12-01"
}

Response:
{
  "success": true,
  "data": {
    "id": "uuid",
    "category": "餐饮",
    "amount": 150.50
  }
}
```

#### GET /api/expenses/:planId
获取指定计划的所有费用记录

#### GET /api/expenses/:planId/summary
获取费用统计汇总
```json
Response:
{
  "success": true,
  "data": {
    "totalExpenses": 5678.90,
    "budget": 10000,
    "remaining": 4321.10,
    "breakdown": {
      "餐饮": 1500,
      "交通": 2000,
      "住宿": 2000
    }
  }
}
```

#### DELETE /api/expenses/:id
删除费用记录

### 地图服务模块

#### GET /api/map/search
搜索地点
```json
Request:
?keyword=东京塔&city=东京

Response:
{
  "success": true,
  "data": {
    "pois": [
      {
        "name": "东京塔",
        "address": "...",
        "location": { "lat": 35.6586, "lng": 139.7454 },
        "type": "景点"
      }
    ]
  }
}
```

#### GET /api/map/route
规划路线
```json
Request:
?origin=lat,lng&destination=lat,lng&mode=transit

Response:
{
  "success": true,
  "data": {
    "distance": 5000,
    "duration": 1200,
    "steps": [...],
    "polyline": "..."
  }
}
```

## 核心功能实现设计

### 1. 智能行程规划

#### 流程设计
```
用户输入（语音/文字）
    ↓
语音识别（如果是语音）
    ↓
需求解析（提取关键信息）
    ↓
调用 LLM API 生成初步方案
    ↓
结构化处理（解析 JSON）
    ↓
地图 API 补充位置信息
    ↓
预算分析与优化
    ↓
返回完整行程方案
    ↓
保存到数据库
```

#### LLM Prompt 设计

**系统提示词**
```
你是一个专业的旅行规划助手。根据用户提供的信息，生成详细的旅行计划。

要求：
1. 返回 JSON 格式数据
2. 包含每日详细行程
3. 包含交通、住宿、景点、餐厅推荐
4. 考虑时间合理性和地理位置
5. 严格控制在预算范围内
6. 根据偏好推荐合适的活动
```

**用户提示词模板**
```
请为我规划一次旅行：
- 目的地：{destination}
- 日期：{startDate} 至 {endDate}（共 {days} 天）
- 预算：{budget} 元
- 人数：{travelersCount} 人
- 偏好：{preferences}

请返回以下 JSON 格式：
{
  "title": "行程标题",
  "overview": "行程概述",
  "dailyItinerary": [
    {
      "day": 1,
      "date": "2025-12-01",
      "theme": "主题",
      "items": [
        {
          "type": "transportation|accommodation|attraction|restaurant|activity",
          "time": "HH:MM",
          "title": "名称",
          "description": "描述",
          "location": "地址",
          "estimatedCost": 金额,
          "tips": "提示"
        }
      ]
    }
  ],
  "budgetBreakdown": {
    "transportation": 金额,
    "accommodation": 金额,
    "food": 金额,
    "activities": 金额,
    "reserve": 金额
  },
  "tips": ["旅行提示"]
}
```

#### 前端实现

**语音输入组件**
```typescript
interface VoiceInputProps {
  onResult: (text: string) => void;
}

const VoiceInput: React.FC<VoiceInputProps> = ({ onResult }) => {
  const [isRecording, setIsRecording] = useState(false);
  const mediaRecorderRef = useRef<MediaRecorder | null>(null);
  
  const startRecording = async () => {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const mediaRecorder = new MediaRecorder(stream);
    const chunks: Blob[] = [];
    
    mediaRecorder.ondataavailable = (e) => chunks.push(e.data);
    mediaRecorder.onstop = async () => {
      const audioBlob = new Blob(chunks, { type: 'audio/wav' });
      const formData = new FormData();
      formData.append('audio', audioBlob);
      
      const response = await fetch('/api/voice/recognize', {
        method: 'POST',
        body: formData
      });
      const { data } = await response.json();
      onResult(data.text);
    };
    
    mediaRecorder.start();
    mediaRecorderRef.current = mediaRecorder;
    setIsRecording(true);
  };
  
  const stopRecording = () => {
    mediaRecorderRef.current?.stop();
    setIsRecording(false);
  };
  
  return (
    <button onClick={isRecording ? stopRecording : startRecording}>
      {isRecording ? '停止录音' : '开始录音'}
    </button>
  );
};
```

**行程规划表单**
```typescript
interface PlanFormData {
  destination: string;
  startDate: string;
  endDate: string;
  budget: number;
  travelersCount: number;
  preferences: {
    interests: string[];
    withKids: boolean;
    accommodation: string;
  };
}

const PlanForm: React.FC = () => {
  const [formData, setFormData] = useState<PlanFormData>({...});
  const [loading, setLoading] = useState(false);
  
  const handleVoiceInput = (text: string) => {
    // 使用正则或 NLP 解析语音文本，填充表单
    const parsed = parseVoiceInput(text);
    setFormData({ ...formData, ...parsed });
  };
  
  const handleSubmit = async () => {
    setLoading(true);
    const response = await fetch('/api/plans/generate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(formData)
    });
    const { data } = await response.json();
    // 跳转到计划详情页
    navigate(`/plans/${data.planId}`);
  };
  
  return (
    <form onSubmit={handleSubmit}>
      <VoiceInput onResult={handleVoiceInput} />
      {/* 表单字段 */}
    </form>
  );
};
```

**地图展示组件**
```typescript
const ItineraryMap: React.FC<{ items: ItineraryItem[] }> = ({ items }) => {
  const mapRef = useRef<any>(null);
  
  useEffect(() => {
    // 初始化高德地图
    const map = new AMap.Map('map-container', {
      zoom: 12,
      center: [items[0].location.lng, items[0].location.lat]
    });
    
    // 添加标记点
    items.forEach((item, index) => {
      if (item.location) {
        const marker = new AMap.Marker({
          position: [item.location.lng, item.location.lat],
          label: { content: `${index + 1}`, offset: new AMap.Pixel(-10, -10) }
        });
        map.add(marker);
      }
    });
    
    // 绘制路线
    const path = items
      .filter(item => item.location)
      .map(item => [item.location.lng, item.location.lat]);
    
    const polyline = new AMap.Polyline({
      path: path,
      strokeColor: '#3366FF',
      strokeWeight: 4
    });
    map.add(polyline);
    
    mapRef.current = map;
  }, [items]);
  
  return <div id="map-container" style={{ width: '100%', height: '500px' }} />;
};
```

### 2. 费用预算与管理

#### 预算分析算法
```typescript
interface BudgetAnalysis {
  totalBudget: number;
  allocation: {
    transportation: number;
    accommodation: number;
    food: number;
    activities: number;
    reserve: number;
  };
  suggestions: string[];
}

const analyzeBudget = async (
  destination: string,
  days: number,
  budget: number,
  travelersCount: number
): Promise<BudgetAnalysis> => {
  const prompt = `
    分析旅行预算分配：
    - 目的地：${destination}
    - 天数：${days}
    - 总预算：${budget} 元
    - 人数：${travelersCount}
    
    请给出合理的预算分配建议，返回 JSON 格式。
  `;
  
  const response = await callLLM(prompt);
  return JSON.parse(response);
};
```

#### 费用记录组件
```typescript
const ExpenseTracker: React.FC<{ planId: string }> = ({ planId }) => {
  const [expenses, setExpenses] = useState<Expense[]>([]);
  const [summary, setSummary] = useState<ExpenseSummary | null>(null);
  
  const addExpense = async (expense: Omit<Expense, 'id'>) => {
    const response = await fetch('/api/expenses', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ...expense, planId })
    });
    const { data } = await response.json();
    setExpenses([...expenses, data]);
    fetchSummary();
  };
  
  const fetchSummary = async () => {
    const response = await fetch(`/api/expenses/${planId}/summary`);
    const { data } = await response.json();
    setSummary(data);
  };
  
  return (
    <div>
      <ExpenseSummaryChart summary={summary} />
      <VoiceExpenseInput onAdd={addExpense} />
      <ExpenseList expenses={expenses} />
    </div>
  );
};
```

#### 语音费用记录
```typescript
const VoiceExpenseInput: React.FC<{ onAdd: (expense: any) => void }> = ({ onAdd }) => {
  const handleVoiceResult = async (text: string) => {
    // 例如："午餐花了150元"
    const prompt = `
      解析这条费用记录："${text}"
      返回 JSON：{ "category": "分类", "amount": 金额, "description": "描述" }
    `;
    
    const response = await callLLM(prompt);
    const expense = JSON.parse(response);
    expense.expenseDate = new Date().toISOString().split('T')[0];
    
    onAdd(expense);
  };
  
  return <VoiceInput onResult={handleVoiceResult} />;
};
```

### 3. 用户管理与数据同步

#### 认证中间件
```typescript
// middleware/auth.ts
export const authMiddleware = async (req, res, next) => {
  const token = req.headers.authorization?.replace('Bearer ', '');
  
  if (!token) {
    return res.status(401).json({ error: 'Unauthorized' });
  }
  
  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    req.user = decoded;
    next();
  } catch (error) {
    return res.status(401).json({ error: 'Invalid token' });
  }
};
```

#### 前端状态管理
```typescript
// store/authStore.ts
import { create } from 'zustand';
import { persist } from 'zustand/middleware';

interface AuthState {
  user: User | null;
  token: string | null;
  login: (email: string, password: string) => Promise<void>;
  logout: () => void;
}

export const useAuthStore = create<AuthState>()(
  persist(
    (set) => ({
      user: null,
      token: null,
      login: async (email, password) => {
        const response = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        const { data } = await response.json();
        set({ user: data.user, token: data.token });
      },
      logout: () => set({ user: null, token: null })
    }),
    { name: 'auth-storage' }
  )
);
```

#### 数据同步机制
```typescript
// hooks/useSync.ts
export const useSync = (planId: string) => {
  const { token } = useAuthStore();
  
  useEffect(() => {
    if (!planId || !token) return;
    
    // 建立 WebSocket 连接实现实时同步
    const ws = new WebSocket(`ws://api.example.com/sync/${planId}`);
    
    ws.onmessage = (event) => {
      const { type, data } = JSON.parse(event.data);
      
      switch (type) {
        case 'plan_updated':
          // 更新本地计划数据
          break;
        case 'expense_added':
          // 更新费用记录
          break;
      }
    };
    
    return () => ws.close();
  }, [planId, token]);
};
```

## 外部服务集成

### 1. 科大讯飞语音识别
```typescript
// services/voiceService.ts
import CryptoJS from 'crypto-js';

export class XFVoiceService {
  private appId: string;
  private apiKey: string;
  private apiSecret: string;
  
  async recognize(audioFile: File): Promise<string> {
    const audioBase64 = await this.fileToBase64(audioFile);
    const url = this.getWebSocketUrl();
    
    return new Promise((resolve, reject) => {
      const ws = new WebSocket(url);
      let result = '';
      
      ws.onopen = () => {
        const params = {
          common: { app_id: this.appId },
          business: { language: 'zh_cn', domain: 'iat' },
          data: { status: 2, format: 'audio/L16;rate=16000', audio: audioBase64 }
        };
        ws.send(JSON.stringify(params));
      };
      
      ws.onmessage = (event) => {
        const response = JSON.parse(event.data);
        if (response.data && response.data.result) {
          result += response.data.result.ws.map(w => w.cw[0].w).join('');
        }
        if (response.code === 0 && response.data.status === 2) {
          ws.close();
          resolve(result);
        }
      };
      
      ws.onerror = reject;
    });
  }
  
  private getWebSocketUrl(): string {
    const host = 'iat-api.xfyun.cn';
    const path = '/v2/iat';
    const date = new Date().toUTCString();
    
    const signatureOrigin = `host: ${host}\ndate: ${date}\nGET ${path} HTTP/1.1`;
    const signature = CryptoJS.HmacSHA256(signatureOrigin, this.apiSecret);
    const signatureBase64 = CryptoJS.enc.Base64.stringify(signature);
    
    const authorization = `api_key="${this.apiKey}", algorithm="hmac-sha256", headers="host date request-line", signature="${signatureBase64}"`;
    const authorizationBase64 = btoa(authorization);
    
    return `wss://${host}${path}?authorization=${authorizationBase64}&date=${encodeURIComponent(date)}&host=${host}`;
  }
  
  private async fileToBase64(file: File): Promise<string> {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => {
        const base64 = (reader.result as string).split(',')[1];
        resolve(base64);
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }
}
```

### 2. 高德地图 API
```typescript
// services/mapService.ts
export class AmapService {
  private apiKey: string;
  
  async searchPOI(keyword: string, city: string) {
    const url = `https://restapi.amap.com/v3/place/text?key=${this.apiKey}&keywords=${keyword}&city=${city}`;
    const response = await fetch(url);
    const data = await response.json();
    
    return data.pois.map(poi => ({
      name: poi.name,
      address: poi.address,
      location: {
        lat: parseFloat(poi.location.split(',')[1]),
        lng: parseFloat(poi.location.split(',')[0])
      },
      type: poi.type
    }));
  }
  
  async getRoute(origin: [number, number], destination: [number, number], mode: string) {
    const url = `https://restapi.amap.com/v3/direction/${mode}?key=${this.apiKey}&origin=${origin.join(',')}&destination=${destination.join(',')}`;
    const response = await fetch(url);
    const data = await response.json();
    
    return {
      distance: data.route.paths[0].distance,
      duration: data.route.paths[0].duration,
      steps: data.route.paths[0].steps
    };
  }
}
```

### 3. LLM API 封装
```typescript
// services/llmService.ts
export class LLMService {
  private apiKey: string;
  private baseUrl: string;
  private model: string;
  
  async chat(systemPrompt: string, userPrompt: string): Promise<string> {
    const response = await fetch(`${this.baseUrl}/chat/completions`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${this.apiKey}`
      },
      body: JSON.stringify({
        model: this.model,
        messages: [
          { role: 'system', content: systemPrompt },
          { role: 'user', content: userPrompt }
        ],
        temperature: 0.7,
        response_format: { type: 'json_object' }
      })
    });
    
    const data = await response.json();
    return data.choices[0].message.content;
  }
}
```

## 配置管理

### 环境变量配置
```bash
# .env.example
# 数据库
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_ANON_KEY=xxx

# JWT
JWT_SECRET=your-secret-key

# 科大讯飞
XF_APP_ID=xxx
XF_API_KEY=xxx
XF_API_SECRET=xxx

# 高德地图
AMAP_KEY=xxx
AMAP_SECRET=xxx

# LLM API
LLM_API_KEY=xxx
LLM_BASE_URL=https://api.openai.com/v1
LLM_MODEL=gpt-4

# 服务端口
PORT=3000
```

### 前端配置页面
```typescript
// pages/Settings.tsx
const Settings: React.FC = () => {
  const [config, setConfig] = useState({
    xfAppId: '',
    xfApiKey: '',
    xfApiSecret: '',
    amapKey: '',
    llmApiKey: ''
  });
  
  const saveConfig = () => {
    localStorage.setItem('api-config', JSON.stringify(config));
    // 重新初始化服务
    initServices(config);
  };
  
  return (
    <form>
      <input 
        placeholder="科大讯飞 APP ID"
        value={config.xfAppId}
        onChange={e => setConfig({...config, xfAppId: e.target.value})}
      />
      <input 
        placeholder="科大讯飞 API Key"
        value={config.xfApiKey}
        onChange={e => setConfig({...config, xfApiKey: e.target.value})}
      />
      <input 
        placeholder="高德地图 Key"
        value={config.amapKey}
        onChange={e => setConfig({...config, amapKey: e.target.value})}
      />
      <input 
        placeholder="LLM API Key"
        value={config.llmApiKey}
        onChange={e => setConfig({...config, llmApiKey: e.target.value})}
      />
      <button onClick={saveConfig}>保存配置</button>
    </form>
  );
};
```

## 部署方案

### Docker 配置

#### Dockerfile (前端)
```dockerfile
FROM node:18-alpine AS builder

WORKDIR /app
COPY package*.json ./
RUN npm ci

COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

#### Dockerfile (后端)
```dockerfile
FROM node:18-alpine

WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN npm run build

EXPOSE 3000
CMD ["node", "dist/index.js"]
```

#### docker-compose.yml
```yaml
version: '3.8'

services:
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "80:80"
    depends_on:
      - backend
    environment:
      - REACT_APP_API_URL=http://backend:3000
  
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    env_file:
      - .env
    environment:
      - NODE_ENV=production
```

### 启动脚本
```bash
#!/bin/bash
# start.sh

echo "启动 AI 旅行规划师..."

# 检查 .env 文件
if [ ! -f .env ]; then
  echo "错误: .env 文件不存在，请先配置环境变量"
  exit 1
fi

# 构建并启动容器
docker-compose up -d --build

echo "应用已启动"
echo "前端地址: http://localhost"
echo "后端地址: http://localhost:3000"
```

## 项目目录结构

```
ai-travel-planner/
├── frontend/
│   ├── public/
│   ├── src/
│   │   ├── components/
│   │   │   ├── VoiceInput.tsx
│   │   │   ├── PlanForm.tsx
│   │   │   ├── ItineraryMap.tsx
│   │   │   ├── ExpenseTracker.tsx
│   │   │   └── ...
│   │   ├── pages/
│   │   │   ├── Home.tsx
│   │   │   ├── PlanDetail.tsx
│   │   │   ├── Plans.tsx
│   │   │   ├── Settings.tsx
│   │   │   └── ...
│   │   ├── services/
│   │   │   ├── voiceService.ts
│   │   │   ├── mapService.ts
│   │   │   ├── apiClient.ts
│   │   │   └── ...
│   │   ├── store/
│   │   │   ├── authStore.ts
│   │   │   ├── planStore.ts
│   │   │   └── ...
│   │   ├── hooks/
│   │   │   ├── useSync.ts
│   │   │   └── ...
│   │   ├── utils/
│   │   ├── types/
│   │   ├── App.tsx
│   │   └── main.tsx
│   ├── package.json
│   ├── Dockerfile
│   └── nginx.conf
├── backend/
│   ├── src/
│   │   ├── controllers/
│   │   │   ├── authController.ts
│   │   │   ├── planController.ts
│   │   │   ├── expenseController.ts
│   │   │   └── ...
│   │   ├── services/
│   │   │   ├── llmService.ts
│   │   │   ├── voiceService.ts
│   │   │   ├── mapService.ts
│   │   │   └── ...
│   │   ├── middleware/
│   │   │   ├── auth.ts
│   │   │   ├── errorHandler.ts
│   │   │   └── ...
│   │   ├── models/
│   │   ├── routes/
│   │   │   ├── auth.ts
│   │   │   ├── plans.ts
│   │   │   ├── expenses.ts
│   │   │   └── ...
│   │   ├── database/
│   │   │   ├── supabase.ts
│   │   │   └── migrations/
│   │   ├── utils/
│   │   └── index.ts
│   ├── package.json
│   └── Dockerfile
├── docker-compose.yml
├── .env.example
├── start.sh
└── README.md
```

## 关键技术实现细节

### 语音转文字流程优化
1. 前端录音时使用 WebM 格式（浏览器原生支持）
2. 上传前转换为 WAV/PCM 格式（科大讯飞要求）
3. 采样率设置为 16000Hz
4. 单声道音频
5. 实现断句识别，支持实时转写

### 地图交互优化
1. 地点聚合：多个相近地点自动聚合显示
2. 路径规划：自动计算最优游览顺序
3. 实时路况：集成实时交通信息
4. 离线地图：支持地图数据缓存

### LLM 调用优化
1. 结构化输出：使用 JSON Mode 确保返回格式正确
2. 重试机制：API 调用失败自动重试
3. 流式输出：支持 SSE 实时返回生成内容
4. 缓存策略：相似请求使用缓存结果

### 性能优化
1. 前端懒加载：路由级别代码分割
2. 图片优化：WebP 格式 + CDN 加速
3. API 请求合并：批量请求减少网络开销
4. 数据库索引：关键字段建立索引
5. Redis 缓存：热点数据缓存

### 安全措施
1. API Key 加密存储
2. HTTPS 传输
3. JWT Token 过期机制
4. SQL 注入防护
5. XSS 防护
6. CORS 配置
7. 请求频率限制
