# AI 旅行规划师设计文档

## 系统架构设计

### 整体架构
```text
前端 (React/Vue) 
    ↓
API 网关层
    ↓
业务服务层 (Node.js/Python)
    ↓
数据存储层 (Supabase/Firebase) + 外部服务 (LLM API, 地图 API, 语音 API)
```

### 技术栈选型

**前端**
- 框架：React + TypeScript
- 状态管理：Zustand / Redux Toolkit
- UI 组件库：Ant Design / Material-UI
- 地图组件：高德地图 Web SDK
- 语音录制：RecordRTC / MediaRecorder API

**后端**（已实现）
- 运行时：Node.js 18+
- 框架：Express.js
- 语言：TypeScript
- 认证：JWT (jsonwebtoken) + bcrypt

**数据库与认证**（已实现）
- Supabase (PostgreSQL)
- 自定义 JWT 认证（非 Supabase Auth）
- 使用 service_role key 绕过 RLS

**外部服务**（已配置）
- LLM：阿里云通义千问 (qwen-plus)
- 语音识别：科大讯飞语音听写 API
- 地图服务：高德地图 Web API

**部署**
- 容器化：Docker + Docker Compose
- 前端：Nginx
- 后端：Node.js

## 数据库设计

### 用户表 (users)
```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  email VARCHAR(255) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  username VARCHAR(100),
  avatar_url TEXT,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

### 旅行计划表 (travel_plans)
```sql
CREATE TABLE travel_plans (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  title VARCHAR(255) NOT NULL,
  destination VARCHAR(255) NOT NULL,
  start_date DATE NOT NULL,
  end_date DATE NOT NULL,
  budget DECIMAL(10, 2),
  budget_breakdown JSONB,
  travelers_count INTEGER,
  preferences JSONB,
  status VARCHAR(50) DEFAULT 'draft',
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

### 行程详情表 (itinerary_items)
```sql
CREATE TABLE itinerary_items (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  plan_id UUID REFERENCES travel_plans(id) ON DELETE CASCADE,
  day_number INTEGER NOT NULL,
  day_theme VARCHAR(255),
  item_type VARCHAR(50) NOT NULL,
  title VARCHAR(255) NOT NULL,
  description TEXT,
  location JSONB,
  start_time TIME,
  end_time TIME,
  estimated_cost DECIMAL(10, 2),
  booking_info JSONB,
  sort_order INTEGER,
  created_at TIMESTAMP DEFAULT NOW()
);
```

### 费用记录表 (expenses)
```sql
CREATE TABLE expenses (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  plan_id UUID REFERENCES travel_plans(id) ON DELETE CASCADE,
  category VARCHAR(100) NOT NULL,
  amount DECIMAL(10, 2) NOT NULL,
  currency VARCHAR(10) DEFAULT 'CNY',
  description TEXT,
  expense_date DATE NOT NULL,
  created_by VARCHAR(50),
  created_at TIMESTAMP DEFAULT NOW()
);
```

### 用户偏好表 (user_preferences)
```sql
CREATE TABLE user_preferences (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  preference_key VARCHAR(100) NOT NULL,
  preference_value JSONB,
  updated_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(user_id, preference_key)
);
```

## API 接口设计

### 类型标签规范

**行程项目和费用类型标签（统一使用中文）**
- 交通
- 住宿
- 餐饮
- 景点
- 其他

**说明：**
- 所有 API 输入输出均使用中文标签
- LLM 返回的 type 字段必须是中文
- 数据库存储使用中文
- 前端展示直接使用中文，无需转换

### 认证模块

#### POST /api/auth/register
注册新用户
```json
Request:
{
  "email": "user@example.com",
  "password": "password123",
  "username": "username"
}

Response:
{
  "success": true,
  "data": {
    "user": { "id": "uuid", "email": "user@example.com" },
    "token": "jwt_token"
  }
}
```

#### POST /api/auth/login
用户登录
```json
Request:
{
  "email": "user@example.com",
  "password": "password123"
}

Response:
{
  "success": true,
  "data": {
    "user": { "id": "uuid", "email": "user@example.com" },
    "token": "jwt_token"
  }
}
```

#### POST /api/auth/logout
用户登出

### 语音模块

#### POST /api/voice/recognize
语音识别
```json
Request:
Content-Type: multipart/form-data
{
  "audio": File (WAV/MP3)
}

Response:
{
  "success": true,
  "data": {
    "text": "我想去日本，5天，预算1万元",
    "confidence": 0.95
  }
}
```

### 行程规划模块

#### POST /api/plans/extract
从自然语言提取旅行需求信息

```json
Request:
{
  "userInput": "我想去日本，5天，预算1万元，喜欢美食和动漫，带孩子"
}

Response:
{
  "success": true,
  "data": {
    "destination": "日本",
    "duration": 5,
    "startDate": null,
    "endDate": null,
    "budget": 10000,
    "travelersCount": 2,
    "preferences": {
      "interests": ["美食", "动漫"],
      "specialNeeds": ["带孩子"]
    }
  }
}
```

#### POST /api/plans/generate
生成旅行计划（基于结构化信息）

```json
Request:
{
  "destination": "日本",
  "startDate": "2025-12-01",
  "endDate": "2025-12-05",
  "budget": 10000,
  "travelersCount": 2,
  "preferences": {
    "interests": ["美食", "动漫"],
    "specialNeeds": ["带孩子"]
  }
}

Response:
{
  "success": true,
  "data": {
    "planId": "uuid",
    "title": "日本5日游",
    "itinerary": [
      {
        "day": 1,
        "date": "2025-12-01",
        "theme": "东京初体验",
        "items": [
          {
            "type": "交通",
            "title": "上海->东京",
            "time": "08:00-12:00",
            "cost": 2000,
            "details": {}
          },
          {
            "type": "住宿",
            "title": "东京XX酒店",
            "cost": 800,
            "location": { "lat": 35.6762, "lng": 139.6503 }
          },
          {
            "type": "景点",
            "title": "浅草寺",
            "time": "14:00-16:00",
            "cost": 0,
            "location": { "lat": 35.7148, "lng": 139.7967 }
          },
          {
            "type": "餐饮",
            "title": "一兰拉面",
            "time": "18:00-19:00",
            "cost": 100
          }
        ]
      }
    ],
    "budgetBreakdown": {
      "交通": 4000,
      "住宿": 3000,
      "餐饮": 2000,
      "景点": 1000,
      "其他": 0
    }
  }
}
```

#### GET /api/plans
获取用户的所有旅行计划
```json
Response:
{
  "success": true,
  "data": {
    "plans": [
      {
        "id": "uuid",
        "title": "日本5日游",
        "destination": "日本",
        "startDate": "2025-12-01",
        "endDate": "2025-12-05",
        "status": "draft"
      }
    ]
  }
}
```

#### GET /api/plans/:id
获取指定旅行计划详情

#### DELETE /api/plans/:id
删除旅行计划

### 费用管理模块

#### POST /api/expenses
添加费用记录（支持语音和文字输入）
```json
Request:
{
  "planId": "uuid",
  "category": "餐饮",
  "amount": 150.50,
  "description": "午餐",
  "expenseDate": "2025-12-01"
}

Response:
{
  "success": true,
  "data": {
    "id": "uuid",
    "planId": "uuid",
    "category": "餐饮",
    "amount": 150.50,
    "description": "午餐",
    "expenseDate": "2025-12-01"
  }
}
```

#### GET /api/expenses/:planId
获取指定计划的所有费用记录
```json
Response:
{
  "success": true,
  "data": {
    "expenses": [
      {
        "id": "uuid",
        "category": "餐饮",
        "amount": 150.50,
        "description": "午餐",
        "expenseDate": "2025-12-01"
      }
    ]
  }
}
```

#### GET /api/expenses/:planId/summary
获取费用统计汇总
```json
Response:
{
  "success": true,
  "data": {
    "totalExpenses": 5678.90,
    "budget": 10000,
    "remaining": 4321.10,
    "percentage": 56.79,
    "breakdown": {
      "交通": 2000,
      "住宿": 2000,
      "餐饮": 1500,
      "景点": 178.90,
      "其他": 0
    }
  }
}
```

#### POST /api/expenses/:planId/analyze
AI 费用分析（对比预算与实际支出，提供建议）
```json
Response:
{
  "success": true,
  "data": {
    "budgetStatus": "正常",
    "spendingTrend": "消费较为平稳",
    "suggestions": [
      "餐饮支出占比较高，建议适当控制",
      "还剩2天行程，剩余预算充足"
    ],
    "forecast": {
      "estimatedTotal": 9800,
      "riskLevel": "低"
    },
    "categoryAnalysis": [
      {
        "category": "餐饮",
        "percentage": 26.4,
        "status": "偏高"
      },
      {
        "category": "交通",
        "percentage": 35.2,
        "status": "合理"
      }
    ]
  }
}
```

#### DELETE /api/expenses/:id
删除费用记录
```json
Response:
{
  "success": true,
  "message": "费用记录已删除"
}
```

### 用户偏好模块

#### GET /api/preferences
获取用户偏好设置
```json
Response:
{
  "success": true,
  "data": {
    "interests": ["美食", "历史文化", "自然风光"],
    "accommodationLevel": "舒适型",
    "transportPreference": "高铁优先",
    "budgetRange": {
      "min": 5000,
      "max": 15000
    },
    "travelPace": "轻松"
  }
}
```

#### PUT /api/preferences
更新用户偏好
```json
Request:
{
  "interests": ["美食", "购物"],
  "accommodationLevel": "豪华型",
  "transportPreference": "飞机优先",
  "budgetRange": {
    "min": 10000,
    "max": 20000
  },
  "travelPace": "适中"
}

Response:
{
  "success": true,
  "message": "偏好已更新"
}
```

### 地图服务模块

#### GET /api/map/search
搜索地点
```json
Request:
?keyword=东京塔&city=东京

Response:
{
  "success": true,
  "data": {
    "pois": [
      {
        "name": "东京塔",
        "address": "...",
        "location": { "lat": 35.6586, "lng": 139.7454 },
        "type": "景点"
      }
    ]
  }
}
```

#### GET /api/map/route
规划路线
```json
Request:
?origin=lat,lng&destination=lat,lng&mode=transit

Response:
{
  "success": true,
  "data": {
    "distance": 5000,
    "duration": 1200,
    "steps": [...],
    "polyline": "..."
  }
}
```

## 核心功能实现设计

### 1. 智能行程规划

#### 流程设计
```text
用户输入（语音/文字）
    ↓
语音识别（如果是语音）
    ↓
【步骤1】LLM 提取关键信息
    ↓
返回结构化数据供用户确认
    ↓
用户确认/修改信息
    ↓
【步骤2】调用 LLM API 生成旅行计划
    ↓
结构化处理（解析 JSON）
    ↓
地图 API 补充位置信息
    ↓
返回完整行程方案
    ↓
保存到数据库
```

#### 实现要点

**1. 两步式交互流程**
- 第一步：信息提取和确认
  - 使用 LLM 从自然语言中提取结构化信息
  - 允许用户确认和修改提取的信息
  - 避免误解用户意图
  
- 第二步：生成详细计划
  - 基于确认后的结构化信息生成计划
  - 调用地图 API 获取位置信息
  - 返回带有地理坐标的完整行程

**2. 语音输入处理**
- 使用浏览器 MediaRecorder API 录音
- 调用科大讯飞语音识别服务
- 支持实时反馈和重新录制

**3. 地图集成**
- 使用高德地图 Web SDK 展示行程
- 标记景点、酒店等位置
- 绘制路线连接各个地点
- 支持地点搜索和导航

#### LLM Prompt 设计

**步骤1: 信息提取 Prompt**

系统提示词：
```text
你是一个旅行需求分析助手。从用户的自然语言描述中提取旅行规划所需的关键信息。

要求：
1. 返回严格的 JSON 格式数据
2. 尽可能推断缺失的信息
3. 对不确定的信息标注 null
4. 识别用户偏好（兴趣、特殊需求）

返回格式:
{
  "destination": "目的地",
  "duration": 天数,
  "startDate": "起始日期或null",
  "endDate": "结束日期或null",
  "budget": 预算金额,
  "travelersCount": 人数,
  "preferences": {
    "interests": ["兴趣标签"],
    "specialNeeds": ["特殊需求标签，如：带孩子、带老人、无障碍需求等"]
  }
}
```

用户输入示例：
```text
"我想去日本，5天，预算1万元，喜欢美食和动漫，带孩子"
```

期望输出：
```json
{
  "destination": "日本",
  "duration": 5,
  "startDate": null,
  "endDate": null,
  "budget": 10000,
  "travelersCount": 2,
  "preferences": {
    "interests": ["美食", "动漫"],
    "specialNeeds": ["带孩子"]
  }
}
```

**步骤2: 行程生成 Prompt**

系统提示词：
```text
你是一个专业的旅行规划助手。根据用户提供的结构化信息，生成详细的旅行计划。

要求：
1. 返回严格的 JSON 格式数据
2. 包含每日详细行程（交通、住宿、景点、餐饮）
3. 考虑时间合理性和地理位置
4. 严格控制在预算范围内
5. 充分考虑用户偏好
6. type 字段必须使用中文：交通、住宿、餐饮、景点、其他

返回格式：
{
  "title": "行程标题",
  "dailyItinerary": [
    {
      "day": 1,
      "date": "2025-12-01",
      "theme": "主题",
      "items": [
        {
          "type": "交通|住宿|餐饮|景点|其他",
          "title": "名称",
          "time": "HH:MM",
          "cost": 金额,
          "location": {"lat": 纬度, "lng": 经度},
          "description": "描述"
        }
      ]
    }
  ],
  "budgetBreakdown": {
    "交通": 金额,
    "住宿": 金额,
    "餐饮": 金额,
    "景点": 金额,
    "其他": 金额
  }
}
```

用户信息示例：
```json
{
  "destination": "日本",
  "startDate": "2025-12-01",
  "endDate": "2025-12-05",
  "budget": 10000,
  "travelersCount": 2,
  "preferences": {
    "interests": ["美食", "动漫"],
    "specialNeeds": ["带孩子"]
  }
}
```

#### 数据结构标准

**提取的用户需求结构**
```typescript
interface ExtractedTravelInfo {
  destination: string;           // 目的地
  duration: number;               // 天数
  startDate: string | null;       // 开始日期 (YYYY-MM-DD)
  endDate: string | null;         // 结束日期 (YYYY-MM-DD)
  budget: number;                 // 预算（元）
  travelersCount: number;         // 旅行人数
  preferences: {
    interests: string[];          // 兴趣标签
    specialNeeds: string[];       // 特殊需求（如：带孩子、带老人等）
  };
}
```

**生成的行程结构**
```typescript
interface TravelPlan {
  planId: string;
  title: string;
  dailyItinerary: DailyItinerary[];
  budgetBreakdown: BudgetBreakdown;
}

interface DailyItinerary {
  day: number;
  date: string;                   // YYYY-MM-DD
  theme: string;
  items: ItineraryItem[];
}

interface ItineraryItem {
  type: '交通' | '住宿' | '餐饮' | '景点' | '其他';
  title: string;
  time?: string;                  // HH:MM 或 HH:MM-HH:MM
  cost: number;
  location?: {
    lat: number;
    lng: number;
  };
  description?: string;
}

interface BudgetBreakdown {
  交通: number;
  住宿: number;
  餐饮: number;
  景点: number;
  其他: number;
}
```

### 2. 费用预算与管理

#### 流程设计
```text
用户添加费用（语音/文字）
    ↓
语音识别（如果是语音）
    ↓
LLM 解析费用信息
    ↓
结构化费用数据
    ↓
保存到数据库
    ↓
更新费用统计
    ↓
（可选）触发 AI 分析
```

#### 实现要点

**1. 费用记录**
- 支持语音输入（如："午餐花了150元"）
- 支持手动输入分类、金额、描述
- 自动关联到旅行计划
- 记录时间和创建者

**2. 费用统计**
- 实时计算总支出
- 按类别汇总费用
- 计算剩余预算
- 预算使用百分比

**3. AI 费用分析**
- 对比预算与实际支出
- 分析消费趋势
- 预测总支出
- 提供节省建议
- 超支预警

#### LLM Prompt 设计

**语音费用解析 Prompt**

系统提示词：
```text
你是一个费用记录助手。从用户的自然语言描述中提取费用信息。

要求：
1. 返回严格的 JSON 格式
2. 类型必须是中文：交通、住宿、餐饮、景点、其他
3. 金额必须是数字
4. 自动推断合适的类别

返回格式：
{
  "category": "类型（交通|住宿|餐饮|景点|其他）",
  "amount": 金额,
  "description": "描述"
}
```

用户输入示例：
```text
"午餐吃拉面花了150元"
```

期望输出：
```json
{
  "category": "餐饮",
  "amount": 150,
  "description": "午餐 - 拉面"
}
```

**费用分析 Prompt**

系统提示词：
```text
你是一个旅行财务分析师。根据旅行预算和实际支出情况，提供专业的分析和建议。

要求：
1. 返回严格的 JSON 格式
2. 分析预算使用情况
3. 预测剩余行程的开销
4. 给出具体的节省或调整建议
5. 评估超支风险

返回格式：
{
  "budgetStatus": "正常|接近超支|已超支",
  "spendingTrend": "描述消费趋势",
  "suggestions": ["具体建议"],
  "forecast": {
    "estimatedTotal": 预测总额,
    "riskLevel": "低|中|高"
  },
  "categoryAnalysis": [
    {
      "category": "类型",
      "percentage": 占比,
      "status": "合理|偏高|偏低"
    }
  ]
}
```

输入信息示例：
```json
{
  "budget": 10000,
  "totalExpenses": 5678.90,
  "remainingDays": 2,
  "totalDays": 5,
  "expensesByCategory": {
    "交通": 2000,
    "住宿": 2000,
    "餐饮": 1500,
    "景点": 178.90,
    "其他": 0
  }
}
```

#### 数据结构标准

**费用记录结构**
```typescript
interface Expense {
  id: string;
  planId: string;
  category: '交通' | '住宿' | '餐饮' | '景点' | '其他';
  amount: number;
  currency: string;               // 默认 'CNY'
  description: string;
  expenseDate: string;            // YYYY-MM-DD
  createdAt: string;
}
```

**费用统计结构**
```typescript
interface ExpenseSummary {
  totalExpenses: number;
  budget: number;
  remaining: number;
  percentage: number;             // 已花费百分比
  breakdown: {
    交通: number;
    住宿: number;
    餐饮: number;
    景点: number;
    其他: number;
  };
}
```

**AI 分析结果结构**
```typescript
interface ExpenseAnalysis {
  budgetStatus: '正常' | '接近超支' | '已超支';
  spendingTrend: string;
  suggestions: string[];
  forecast: {
    estimatedTotal: number;
    riskLevel: '低' | '中' | '高';
  };
  categoryAnalysis: {
    category: string;
    percentage: number;
    status: '合理' | '偏高' | '偏低';
  }[];
}
```

### 3. 用户管理与数据存储

#### 实现要点

**1. 认证机制**
- 自定义 JWT 认证（非 Supabase Auth）
- 使用 bcrypt 加密密码
- Token 有效期 7 天
- 所有需要认证的接口都需要 JWT 中间件

**2. 数据同步**
- 所有数据存储在 Supabase PostgreSQL
- 用户登录后自动同步云端数据
- 支持多设备访问
- 使用 service_role key 绕过 RLS

**3. 数据隔离**
- 每个用户只能访问自己的数据
- 通过 JWT 中的 userId 进行数据过滤
- 在后端控制器层进行权限检查

### 4. 用户偏好管理

#### 实现要点

**1. 偏好设置**
- 常用旅行兴趣标签
- 住宿标准偏好
- 交通方式偏好
- 旅行节奏偏好
- 预算范围偏好

**2. 偏好应用**
- 新建计划时自动填充用户偏好
- 用户可以在创建时覆盖默认偏好
- 从历史计划中学习偏好

**3. 学习机制**
- 统计用户历史计划中的常见标签
- 计算平均预算范围
- 提取出现频率高的偏好

#### 数据结构标准

**用户偏好结构**
```typescript
interface UserPreferences {
  interests: string[];            // 兴趣爱好
  accommodationLevel: string;     // 住宿标准
  transportPreference: string;    // 交通偏好
  budgetRange: {
    min: number;
    max: number;
  };
  travelPace: string;             // 旅行节奏
}
```

## 外部服务集成

### 1. 科大讯飞语音识别

**接入方式**
- WebSocket 实时语音识别 API
- 支持音频格式：PCM、WAV、MP3
- 采样率：16000Hz
- 语言：中文（zh_cn）

**集成要点**
- 生成认证签名（HMAC-SHA256）
- 音频数据 Base64 编码
- WebSocket 连接和消息处理
- 实时返回识别结果

**API 密钥配置**
- `XF_APP_ID`
- `XF_API_KEY`
- `XF_API_SECRET`

### 2. 高德地图 API

**使用功能**
- 地点搜索（Place Search）
- 路线规划（Direction API）
- 地图展示（Web SDK）
- 地理编码

**集成要点**
- RESTful API 调用
- 返回 POI 信息（名称、地址、坐标）
- 前端地图组件集成
- 标记点和路线绘制

**API 密钥配置**
- `AMAP_KEY`

### 3. 阿里云通义千问 LLM

**模型选择**
- 模型：qwen-plus
- API 格式：OpenAI 兼容格式
- 支持 JSON Mode

**使用场景**
- 提取旅行需求信息
- 生成旅行计划
- 解析语音费用记录
- 分析费用趋势

**集成要点**
- 使用兼容 OpenAI 的 API 格式
- 设置 `response_format: { type: 'json_object' }` 确保 JSON 输出
- Temperature 设置为 0.7
- System prompt 和 user prompt 分离

**API 密钥配置**
- `LLM_API_KEY`
- `LLM_BASE_URL`
- `LLM_MODEL`

## 配置管理

### 环境变量配置

**后端环境变量（.env）**
```bash
# 服务器
PORT=3000
NODE_ENV=development

# 数据库（Supabase）
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_SERVICE_ROLE_KEY=xxx

# JWT（自定义认证）
JWT_SECRET=your-secret-key-generate-random-string
JWT_EXPIRES_IN=7d

# 科大讯飞语音识别
XF_APP_ID=xxx
XF_API_KEY=xxx
XF_API_SECRET=xxx

# 高德地图
AMAP_KEY=xxx

# LLM API（通义千问）
LLM_API_KEY=sk-xxx
LLM_BASE_URL=https://dashscope.aliyuncs.com/compatible-mode/v1
LLM_MODEL=qwen-plus
```

**重要说明**
- 使用 `SUPABASE_SERVICE_ROLE_KEY` 而非 `SUPABASE_ANON_KEY`
- 因为项目使用自定义 JWT 认证，需要绕过 Supabase RLS
- `JWT_SECRET` 需要自己生成随机字符串
- LLM 使用阿里云通义千问（国内访问更稳定）
- **禁止将 API Key 提交到 GitHub**

### 前端 API 配置

**方式1：环境变量（推荐）**
```bash
# .env.local
REACT_APP_API_URL=http://localhost:3000
REACT_APP_AMAP_KEY=xxx
```

**方式2：设置页面输入**
- 提供设置页面让用户输入 API Key
- 使用 localStorage 保存配置
- 初始化时从 localStorage 读取配置

## 部署方案

### Docker 配置

**后端 Dockerfile**
```dockerfile
FROM node:18-alpine

WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN npm run build

EXPOSE 3000
CMD ["node", "dist/index.js"]
```

**docker-compose.yml**
```yaml
version: '3.8'

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    env_file:
      - .env
    environment:
      - NODE_ENV=production
```

### 启动说明

**使用 Docker**
```bash
# 1. 克隆项目
git clone https://github.com/your-username/ai-travel-planner.git
cd ai-travel-planner

# 2. 配置环境变量
cp .env.example .env
# 编辑 .env 文件，填入你的 API Keys

# 3. 启动服务
docker-compose up -d

# 4. 访问
# 后端 API: http://localhost:3000
```

**本地开发**
```bash
# 后端
cd backend
npm install
npm run dev

# 前端（待开发）
cd frontend
npm install
npm start
```

## 关键技术要点

### 1. 自然语言理解（NLU）
- 使用 LLM 从用户输入中提取结构化信息
- 两步式交互：提取 → 确认 → 生成
- 支持模糊输入，智能推断缺失信息
- 使用 JSON Mode 确保返回格式正确

### 2. 语音识别集成
- 科大讯飞语音听写 WebSocket API
- 浏览器 MediaRecorder API 录音
- 音频格式：WAV，采样率 16000Hz
- 支持实时反馈和错误重试

### 3. 地图服务集成
- 高德地图 Web API（后端）
- 高德地图 Web SDK（前端）
- POI 搜索和路线规划
- 地图可视化展示行程
- 自动计算地点间距离和时间

### 4. LLM 应用场景
- **信息提取**：从自然语言中提取旅行需求
- **行程生成**：基于结构化信息生成详细计划
- **费用分析**：分析消费趋势，提供优化建议
- **语音解析**：将语音费用描述转为结构化数据

### 5. 类型标签规范
- 统一使用中文标签：交通、住宿、餐饮、景点、其他
- API 输入输出使用中文
- LLM 返回使用中文
- 数据库存储使用中文
- 前端展示使用中文（无需转换）

### 6. 数据安全
- 自定义 JWT Token 认证
- bcrypt 密码加密
- API Key 不提交到代码仓库
- 使用环境变量管理密钥
- Supabase service_role key 绕过 RLS

### 7. 数据结构标准化
- 提取需求：固定 JSON 结构（destination, duration, budget, preferences）
- preferences 包含 interests 和 specialNeeds
- 行程生成：统一类型标签（中文）和数据格式
- 费用记录：与行程类型标签对齐（中文）
- 所有 LLM 返回使用 JSON Mode

### 8. 前后端分离架构
- 后端：Node.js + Express + TypeScript（已完成）
- 前端：React + TypeScript（待开发）
- 数据库：Supabase PostgreSQL
- 认证：自定义 JWT（非 Supabase Auth）
